<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>KC-WebTraceï½œå°è‚¡æ’è¡Œ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />


  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      margin: 0;
      padding: 20px;
      background: #f5f7fa;
    }

    h1 {
      margin-bottom: 6px;
    }

    .meta {
      color: #666;
      margin-bottom: 16px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      text-align: right;
      font-size: 14px;
    }

    th {
      background: #f0f2f5;
      color: #333;
    }

    th:first-child,
    td:first-child {
      text-align: center;
      width: 60px;
    }

    th:nth-child(2),
    td:nth-child(2),
    th:nth-child(3),
    td:nth-child(3) {
      text-align: left;
    }

    .up {
      color: #c0392b;
      font-weight: 600;
    }

    .down {
      color: #27ae60;
      font-weight: 600;
    }

    .loading {
      padding: 20px;
      color: #999;
    }

    footer {
      margin-top: 20px;
      font-size: 12px;
      color: #999;
    }

  .delta-new { color: #8e44ad; font-weight: 600; }
  .delta-up { color: #c0392b; font-weight: 600; }
  .delta-down { color: #27ae60; font-weight: 600; }
  .delta-same { color: #7f8c8d; }
  </style>
</head>

<body>

<h1>ğŸ“ˆ å°è‚¡æ¼²å¹…æ’è¡Œ Dashboard</h1>
<div class="meta" id="meta">è¼‰å…¥ä¸­â€¦</div>

<div id="content" class="loading">Loading dataâ€¦</div>

<footer>
  è³‡æ–™ä¾†æºï¼šé‰…äº¨ç¶²ï½œæœ¬é ç‚ºè§€æ¸¬ç”¨é€”ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°
</footer>

<script>
const today = "latest";
const yesterday = null; // å…ˆé—œé–‰æ˜¨æ—¥æ¯”å°

async function loadJSON(date) {
  try {
    const res = await fetch(`./data/${today}.json`);
    return await res.json();
  } catch {
    return null;
  }
}

function buildYesterdayMap(yesterdayItems) {
  const map = {};
  if (!yesterdayItems) return map;

  yesterdayItems.forEach(item => {
    map[item.code] = item.rank;
  });
  return map;
}

function calcDelta(todayItem, yesterdayMap) {
  const yRank = yesterdayMap[todayItem.code];

  if (yRank === undefined) {
    return { label: "ğŸ†• æ–°é€²æ¦œ", cls: "delta-new" };
  }

  if (yRank > todayItem.rank) {
    return { label: `â¬† +${yRank - todayItem.rank}`, cls: "delta-up" };
  }

  if (yRank < todayItem.rank) {
    return { label: `â¬‡ -${todayItem.rank - yRank}`, cls: "delta-down" };
  }

  return { label: "â¸", cls: "delta-same" };
}

async function run() {
  const todayData = await loadJSON(today);

  if (!todayData) {
    return;
  }

  // ï¼ˆ1ï¼‰Momentum è¨ˆç®—
  for (const item of todayData.items) {
    item.momentum = await calcMomentum(item.code, historyDates);
  }

  // ğŸ”½ã€å°±åœ¨é€™è£¡ï¼ŒåŠ  Composite Scoreã€‘ğŸ”½
  for (const item of todayData.items) {
    item.composite = Number(
      (item.changePct * item.momentum).toFixed(2)
    );
  }

  // ğŸ”½ã€æ¥è‘—ç«‹åˆ»ç”¨ Composite æ’åºã€‘ğŸ”½
  todayData.items.sort((a, b) => b.composite - a.composite);

  // ï¼ˆ2ï¼‰renderMeta
  renderMeta(todayData, null);

  // ï¼ˆ3ï¼‰renderTable
  renderTable(todayData.items, diffItems(todayData, null));
}


  let yesterdayData = null;
  if (yesterday) {
    yesterdayData = await loadJSON(yesterday);
  }

  renderMeta(todayData, yesterdayData);
  renderTable(todayData.items, diffItems(todayData, yesterdayData));
}

 function renderMeta(todayData, yesterdayData) {
  const meta = document.getElementById("meta");

  if (!todayData) {
    meta.innerText = "âš  ç„¡è³‡æ–™";
    return;
  }

  const date = todayData.date || "N/A";
  const count = todayData.count || todayData.items.length;

  let note = "";
  if (!yesterdayData) {
    note = "ï½œç„¡æ˜¨æ—¥è³‡æ–™";
  }

  meta.innerText = `æ—¥æœŸï¼š${date} ï½œ ç­†æ•¸ï¼š${count} ${note}`;
}
 

function renderTable(items, yesterdayMap) {
  const container = document.getElementById("content");

  let html = `
    <table>
      <thead>
        <tr>
          <th>Rank</th>
          <th>è®ŠåŒ–</th>
          <th>ä»£ç¢¼</th>
          <th>åç¨±</th>
          <th>æ”¶ç›¤åƒ¹</th>
          <th>æ¼²è·Œå¹… (%)</th>
        </tr>
      </thead>
      <tbody>
  `;

  items.forEach(item => {
    const delta = calcDelta(item, yesterdayMap);
    const cls = item.changePct >= 0 ? "up" : "down";

    html += `
      <tr>
        <td>${item.rank}</td>
        <td class="${delta.cls}">${delta.label}</td>
        <td>${item.code}</td>
        <td>${item.name}</td>
        <td>${item.close.toFixed(2)}</td>
        <td class="${cls}">${item.changePct.toFixed(2)}</td>
      </tr>
    `;
  });

  html += `
      </tbody>
    </table>
  `;

  container.innerHTML = html;
}

function diffItems(todayData, yesterdayData) {
  // å°šæœªå•Ÿç”¨æ˜¨æ—¥æ¯”å°ï¼Œå›å‚³ç©ºç‰©ä»¶å³å¯
  return {};
}

  
</script>

<script type="module">
  const BUILD_ID = "2026-01-14-01";
  console.log("KC Dashboard build:", BUILD_ID);

  window.run(); // â† æ˜ç¢ºå‘¼å«
</script>

</body>
</html>
