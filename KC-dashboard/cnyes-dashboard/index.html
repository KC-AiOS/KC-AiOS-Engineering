<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>KC-WebTraceï½œå°è‚¡æ’è¡Œ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    /* ====== Base Styles ====== */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      margin: 0;
      padding: 20px;
      background: #f5f7fa;
    }

    h1 {
      margin-bottom: 6px;
    }

    footer {
      margin-top: 20px;
      font-size: 12px;
      color: #999;
    }

    /* ====== Meta Info ====== */
    .meta {
      color: #666;
      margin-bottom: 16px;
      font-size: 14px;
    }

    /* ====== Table Styles ====== */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      text-align: right;
      font-size: 14px;
    }

    th {
      background: #f0f2f5;
      color: #333;
    }

    th:first-child,
    td:first-child {
      text-align: center;
      width: 60px;
    }

    th:nth-child(2),
    td:nth-child(2),
    th:nth-child(3),
    td:nth-child(3) {
      text-align: left;
    }

    /* ====== Status Styles ====== */
    .loading {
      padding: 20px;
      color: #999;
    }

    .error {
      padding: 20px;
      color: #c0392b;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    /* ====== Price Change Styles ====== */
    .up {
      color: #c0392b;
      font-weight: 600;
    }

    .down {
      color: #27ae60;
      font-weight: 600;
    }

    /* ====== Rank Delta Styles ====== */
    .delta-new {
      color: #8e44ad;
      font-weight: 600;
    }

    .delta-up {
      color: #c0392b;
      font-weight: 600;
    }

    .delta-down {
      color: #27ae60;
      font-weight: 600;
    }

    .delta-same {
      color: #7f8c8d;
    }

    /* ====== Range Selector ====== */
    .range-btn {
      padding: 6px 12px;
      margin-right: 6px;
      border: none;
      border-radius: 4px;
      background: #dfe6e9;
      cursor: pointer;
      font-size: 14px;
    }

    .range-btn.active {
      background: #0984e3;
      color: white;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <h1>ğŸ“ˆ å°è‚¡æ¼²å¹…æ’è¡Œ Dashboard</h1>
  <div class="meta" id="meta">è¼‰å…¥ä¸­â€¦</div>

  <div id="range-selector" style="margin-bottom: 12px;">
    <button data-range="50" class="range-btn active">Top 50</button>
    <button data-range="100" class="range-btn">Top 100</button>
    <button data-range="200" class="range-btn">Top 200</button>
  </div>

  <div id="content" class="loading">Loading dataâ€¦</div>

  <footer>
    è³‡æ–™ä¾†æºï¼šé‰…äº¨ç¶²ï½œæœ¬é ç‚ºè§€æ¸¬ç”¨é€”ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°
  </footer>

  <script>
    /* ============================================================================
     * Global State
     * ============================================================================ */
    const State = {
      todayData: null,
      yesterdayMap: {},
      currentRange: 50
    };

    /* ============================================================================
     * Data Loading
     * ============================================================================ */
    async function loadJSON(date) {
      try {
        const url = `./data/${date}.json?t=${Date.now()}`;
        const res = await fetch(url, { cache: "no-store" });

        if (!res.ok) {
          console.warn(`[KC AiOS] æª”æ¡ˆ ${date}.json ä¸å­˜åœ¨`);
          return null;
        }
        return await res.json();
      } catch (err) {
        console.error("è¼‰å…¥ JSON å¤±æ•—:", err);
        return null;
      }
    }

    async function loadTodayData() {
      // å…ˆå˜—è©¦è¼‰å…¥ latest.json
      let data = await loadJSON("latest");
      if (data) return data;

      // å¦‚æœ latest ä¸å­˜åœ¨ï¼Œå˜—è©¦è¼‰å…¥ä»Šæ—¥æ—¥æœŸæª”æ¡ˆ
      const today = new Date().toISOString().slice(0, 10);
      return await loadJSON(today);
    }

    async function loadYesterdayData() {
      return await loadJSON("yesterday");
    }

    /* ============================================================================
     * Data Processing
     * ============================================================================ */
    function buildYesterdayMap(yesterdayData) {
      const map = {};
      if (yesterdayData && yesterdayData.items) {
        yesterdayData.items.forEach(item => {
          map[item.code] = item.rank;
        });
      }
      return map;
    }

    function calcDelta(todayItem, yesterdayMap) {
      const yRank = yesterdayMap[todayItem.code];
      if (yRank === undefined) {
        return { label: "ğŸ†• æ–°é€²æ¦œ", cls: "delta-new" };
      }
      if (yRank > todayItem.rank) {
        return { label: `â¬† +${yRank - todayItem.rank}`, cls: "delta-up" };
      }
      if (yRank < todayItem.rank) {
        return { label: `â¬‡ -${todayItem.rank - yRank}`, cls: "delta-down" };
      }
      return { label: "â¸", cls: "delta-same" };
    }

    /* ============================================================================
     * Rendering
     * ============================================================================ */
      function renderMeta(todayData, yesterdayData) {
      const meta = document.getElementById("meta");
      
      // ä»Šæ—¥æ—¥æœŸï¼šç›´æ¥ä½¿ç”¨ç•¶å‰æ—¥æœŸ
      const today = new Date();
      const date = today.toISOString().slice(0, 10);
      
      // æ˜¨æ—¥æ—¥æœŸï¼šæ ¹æ“šä»Šæ—¥æ—¥æœŸè¨ˆç®—
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const y = yesterday.toISOString().slice(0, 10);
      
      const count = todayData?.items ? todayData.items.length : 0;
      meta.innerText = `æ—¥æœŸï¼š${date} ï½œ ç­†æ•¸ï¼š${count} ï½œ æ˜¨æ—¥ï¼š${y}`;
    }

    function renderTableRange(range) {
      const container = document.getElementById("content");

      if (!State.todayData || !State.todayData.items) {
        container.innerHTML = '<div class="error">ç›®å‰ç„¡æ³•å–å¾—è³‡æ–™ï¼Œè«‹æª¢æŸ¥ data è³‡æ–™å¤¾ã€‚</div>';
        return;
      }

      const items = State.todayData.items.slice(0, range);

      let html = `
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>è®ŠåŒ–</th>
              <th>ä»£ç¢¼</th>
              <th>åç¨±</th>
              <th>æ”¶ç›¤åƒ¹</th>
              <th>æ¼²è·Œå¹… (%)</th>
            </tr>
          </thead>
          <tbody>`;

      items.forEach(item => {
        const delta = calcDelta(item, State.yesterdayMap);
        const close = Number(item.close);
        const pct = Number(item.changePct);
        const cls = pct >= 0 ? "up" : "down";

        html += `
          <tr>
            <td>${item.rank}</td>
            <td class="${delta.cls}">${delta.label}</td>
            <td>${item.code}</td>
            <td>${item.name}</td>
            <td>${Number.isFinite(close) ? close.toFixed(2) : "0.00"}</td>
            <td class="${cls}">${Number.isFinite(pct) ? pct.toFixed(2) : "0.00"}</td>
          </tr>`;
      });

      html += `
          </tbody>
        </table>`;

      container.innerHTML = html;
    }

    /* ============================================================================
     * Event Handlers
     * ============================================================================ */
    function setupRangeSelector() {
      const buttons = document.querySelectorAll(".range-btn");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
          buttons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          // æ›´æ–°ç¯„åœä¸¦é‡æ–°æ¸²æŸ“
          State.currentRange = Number(btn.dataset.range);
          renderTableRange(State.currentRange);
        });
      });
    }

    /* ============================================================================
     * Main Application Logic
     * ============================================================================ */
    async function run() {
      // è¼‰å…¥è³‡æ–™
      State.todayData = await loadTodayData();
      const yesterdayData = await loadYesterdayData();

      // å»ºç«‹æ˜¨æ—¥æ’åå°ç…§è¡¨
      State.yesterdayMap = buildYesterdayMap(yesterdayData);

      // æª¢æŸ¥è³‡æ–™æ˜¯å¦è¼‰å…¥æˆåŠŸ
      if (!State.todayData || !State.todayData.items) {
        document.getElementById("content").innerHTML = '<div class="error">ç›®å‰ç„¡æ³•å–å¾—è³‡æ–™ï¼Œè«‹æª¢æŸ¥ data è³‡æ–™å¤¾ã€‚</div>';
        document.getElementById("meta").innerText = "è³‡æ–™è¼‰å…¥å¤±æ•—";
        return;
      }

      // æ¸²æŸ“é é¢
      renderMeta(State.todayData, yesterdayData);
      renderTableRange(State.currentRange);
    }

    /* ============================================================================
     * Initialization
     * ============================================================================ */
    function init() {
      setupRangeSelector();
      run();
    }

    // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }

    // å°å‡º run å‡½æ•¸ä¾›å¤–éƒ¨èª¿ç”¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
    window.run = run;
  </script>
</body>
</html>
