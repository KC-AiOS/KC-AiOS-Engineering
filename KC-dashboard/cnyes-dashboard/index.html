<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>KC-WebTraceï½œå°è‚¡æ’è¡Œ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />


  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      margin: 0;
      padding: 20px;
      background: #f5f7fa;
    }

    h1 {
      margin-bottom: 6px;
    }

    .meta {
      color: #666;
      margin-bottom: 16px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      text-align: right;
      font-size: 14px;
    }

    th {
      background: #f0f2f5;
      color: #333;
    }

    th:first-child,
    td:first-child {
      text-align: center;
      width: 60px;
    }

    th:nth-child(2),
    td:nth-child(2),
    th:nth-child(3),
    td:nth-child(3) {
      text-align: left;
    }

    .up {
      color: #c0392b;
      font-weight: 600;
    }

    .down {
      color: #27ae60;
      font-weight: 600;
    }

    .loading {
      padding: 20px;
      color: #999;
    }

    footer {
      margin-top: 20px;
      font-size: 12px;
      color: #999;
    }

  .delta-new { color: #8e44ad; font-weight: 600; }
  .delta-up { color: #c0392b; font-weight: 600; }
  .delta-down { color: #27ae60; font-weight: 600; }
  .delta-same { color: #7f8c8d; }
    
    .range-btn {
  padding: 6px 12px;
  margin-right: 6px;
  border: none;
  border-radius: 4px;
  background: #dfe6e9;
  cursor: pointer;
  font-size: 14px;
}

.range-btn.active {
  background: #0984e3;
  color: white;
  font-weight: 600;
}
  </style>
</head>

<body>

<h1>ğŸ“ˆ å°è‚¡æ¼²å¹…æ’è¡Œ Dashboard</h1>
<div class="meta" id="meta">è¼‰å…¥ä¸­â€¦</div>

<div id="content" class="loading">Loading dataâ€¦</div>
  <div id="range-selector" style="margin-bottom: 12px;">
  <button data-range="50" class="range-btn active">Top 50</button>
  <button data-range="100" class="range-btn">Top 100</button>
  <button data-range="200" class="range-btn">Top 200</button>
</div>


<footer>
  è³‡æ–™ä¾†æºï¼šé‰…äº¨ç¶²ï½œæœ¬é ç‚ºè§€æ¸¬ç”¨é€”ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°
</footer>

<script>
  /* ====== Global State ====== */
let GLOBAL_todayData = null;
let GLOBAL_yesterdayMap = {};
let GLOBAL_currentRange = 50;

/* ====== Helpers ====== */

async function loadJSON(date) {
  try {
    const url = `./data/${date}.json?t=${Date.now()}`; // å»ºè­°æ”¹ç”¨ç›¸å°è·¯å¾‘
    const res = await fetch(url, { cache: "no-store" });

    // é—œéµä¿®æ­£ï¼šå¦‚æœ 404ï¼Œä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œè€Œæ˜¯å›å‚³ null
    if (!res.ok) {
      console.warn(`[KC AiOS] æª”æ¡ˆ ${date}.json ä¸å­˜åœ¨`);
      return null; 
    }
    return await res.json();
  } catch (err) {
    console.error("è¼‰å…¥ JSON å¤±æ•—:", err);
    return null;
  }
}

async function loadTodayData() {
  // å„ªå…ˆå˜—è©¦è®€å–æœ€æ–°è³‡æ–™æ¨™ç±¤ï¼Œé€™é€šå¸¸æ˜¯æœ€ç©©å®šçš„å…¥å£
  let data = await loadJSON("latest");
  
  if (data) {
    console.log("æˆåŠŸè¼‰å…¥ latest.json");
    return data;
  }

  // å¦‚æœ latest å¤±æ•—ï¼Œæ‰å˜—è©¦æŠ“å–ç•¶å¤©æ—¥æœŸ
  const today = new Date().toISOString().slice(0, 10);
  console.log(`å˜—è©¦æŠ“å–ç•¶æ—¥æª”æ¡ˆ: ${today}`);
  return await loadJSON(today);
}

async function loadYesterdayData() {
  return await loadJSON("yesterday");
}

function calcDelta(todayItem, yesterdayMap) {
  const yRank = yesterdayMap[todayItem.code];
  if (yRank === undefined) return { label: "ğŸ†• æ–°é€²æ¦œ", cls: "delta-new" };
  if (yRank > todayItem.rank) return { label: `â¬† +${yRank - todayItem.rank}`, cls: "delta-up" };
  if (yRank < todayItem.rank) return { label: `â¬‡ -${todayItem.rank - yRank}`, cls: "delta-down" };
  return { label: "â¸", cls: "delta-same" };
}

function renderMeta(todayData, yesterdayData) {
  const meta = document.getElementById("meta");
  const date = todayData.date || "N/A";
  const count = todayData.items ? todayData.items.length : 0;
  const y = yesterdayData ? yesterdayData.date : "ç„¡";
  meta.innerText = `æ—¥æœŸï¼š${date} ï½œ ç­†æ•¸ï¼š${count} ï½œ æ˜¨æ—¥ï¼š${y}`;
}

function renderTableRange(range) {
  const container = document.getElementById("content");
  const items = GLOBAL_todayData.items.slice(0, range);

  let html = `<table><thead><tr>
    <th>Rank</th><th>è®ŠåŒ–</th><th>ä»£ç¢¼</th><th>åç¨±</th><th>æ”¶ç›¤åƒ¹</th><th>æ¼²è·Œå¹… (%)</th>
  </tr></thead><tbody>`;

  items.forEach(item => {
    const delta = calcDelta(item, GLOBAL_yesterdayMap);
    const close = Number(item.close);
    const pct = Number(item.changePct);
    const cls = pct >= 0 ? "up" : "down";

    html += `
      <tr>
        <td>${item.rank}</td>
        <td class="${delta.cls}">${delta.label}</td>
        <td>${item.code}</td>
        <td>${item.name}</td>
        <td>${Number.isFinite(close) ? close.toFixed(2) : "0.00"}</td>
        <td class="${cls}">${Number.isFinite(pct) ? pct.toFixed(2) : "0.00"}</td>
      </tr>`;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}

/* ====== Main ====== */
async function run() {
  console.log("KC AiOS: run() start");

  GLOBAL_todayData = await loadTodayData();
  
  if (!GLOBAL_todayData || !GLOBAL_todayData.items) {
    document.getElementById("content").innerHTML = 
      `<div style="color:orange; padding:20px;">ç›®å‰ç„¡æ³•å–å¾—è³‡æ–™ï¼Œè«‹æª¢æŸ¥ data è³‡æ–™å¤¾ä¸­æ˜¯å¦æœ‰ latest.json æª”æ¡ˆã€‚</div>`;
    return;
  }

  const yData = await loadYesterdayData();
  // ... å¾ŒçºŒæ¸²æŸ“é‚è¼¯ ...
}

  renderMeta(GLOBAL_todayData, yData);
  renderTableRange(GLOBAL_currentRange);
}

/* ====== Range Button Logic ====== */
function setupRangeSelector() {
  const buttons = document.querySelectorAll(".range-btn");
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      GLOBAL_currentRange = Number(btn.dataset.range);
      renderTableRange(GLOBAL_currentRange);
    });
  });
}

/* ====== Boot ====== */
window.run = run;

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", () => {
    setupRangeSelector();
    run();
  });
} else {
  setupRangeSelector();
  run();
}


</script>
</body>
</html>
