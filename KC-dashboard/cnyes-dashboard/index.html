<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>KC-WebTraceï½œå°è‚¡æ’è¡Œ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />


  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      margin: 0;
      padding: 20px;
      background: #f5f7fa;
    }

    h1 {
      margin-bottom: 6px;
    }

    .meta {
      color: #666;
      margin-bottom: 16px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      text-align: right;
      font-size: 14px;
    }

    th {
      background: #f0f2f5;
      color: #333;
    }

    th:first-child,
    td:first-child {
      text-align: center;
      width: 60px;
    }

    th:nth-child(2),
    td:nth-child(2),
    th:nth-child(3),
    td:nth-child(3) {
      text-align: left;
    }

    .up {
      color: #c0392b;
      font-weight: 600;
    }

    .down {
      color: #27ae60;
      font-weight: 600;
    }

    .loading {
      padding: 20px;
      color: #999;
    }

    footer {
      margin-top: 20px;
      font-size: 12px;
      color: #999;
    }

  .delta-new { color: #8e44ad; font-weight: 600; }
  .delta-up { color: #c0392b; font-weight: 600; }
  .delta-down { color: #27ae60; font-weight: 600; }
  .delta-same { color: #7f8c8d; }
  </style>
</head>

<body>

<h1>ğŸ“ˆ å°è‚¡æ¼²å¹…æ’è¡Œ Dashboard</h1>
<div class="meta" id="meta">è¼‰å…¥ä¸­â€¦</div>

<div id="content" class="loading">Loading dataâ€¦</div>

<footer>
  è³‡æ–™ä¾†æºï¼šé‰…äº¨ç¶²ï½œæœ¬é ç‚ºè§€æ¸¬ç”¨é€”ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°
</footer>

<script>
/* ====== Core Config ====== */

const today = new Date().toISOString().slice(0, 10);
fetch(`./data/${today}.json`)
const yesterday = null;

/* ====== Helpers ====== */
async function loadJSON(date) {
  try {
    const url = `./data/${date}.json?t=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch (err) {
    console.error("è¼‰å…¥ JSON å¤±æ•—:", err);
    return null;
  }
}

async function loadTodayData() {
  const today = new Date().toISOString().slice(0, 10);

  let data = await loadJSON(today);
  if (data) return data;

  data = await loadJSON("latest");
  if (data) return data;

  throw new Error("No data available (today & latest missing)");
}

async function loadYesterdayData() {
  let data = await loadJSON("yesterday"); // å°æ‡‰ data/yesterday.json
  return data; // å¯èƒ½ç‚º nullï¼Œæ²’é—œä¿‚
}

/* æ’åè®ŠåŒ–é‚è¼¯ */
function calcDelta(todayItem, yesterdayMap) {
  const yRank = yesterdayMap[todayItem.code];
  if (yRank === undefined) return { label: "ğŸ†• æ–°é€²æ¦œ", cls: "delta-new" };
  if (yRank > todayItem.rank) return { label: `â¬† +${yRank - todayItem.rank}`, cls: "delta-up" };
  if (yRank < todayItem.rank) return { label: `â¬‡ -${todayItem.rank - yRank}`, cls: "delta-down" };
  return { label: "â¸", cls: "delta-same" };
}

function renderMeta(todayData, yesterdayData) {
  const meta = document.getElementById("meta");
  if (!meta) return;

  if (!todayData) {
    meta.innerText = "âš  ç„¡è³‡æ–™";
    return;
  }

  const date = todayData.date || "N/A";
  const count = Array.isArray(todayData.items) ? todayData.items.length : 0;
  const y = yesterdayData ? yesterdayData.date : "ç„¡";

  meta.innerText = `æ—¥æœŸï¼š${date} ï½œ ç­†æ•¸ï¼š${count} ï½œ æ˜¨æ—¥ï¼š${y}`;
}

function renderTable(items, yesterdayMap) {
  const container = document.getElementById("content");
  if (!container) return;

  if (!items || items.length === 0) {
    container.innerHTML = "ç„¡è³‡æ–™é¡¯ç¤º";
    return;
  }

  let html = `<table><thead><tr>
    <th>Rank</th><th>è®ŠåŒ–</th><th>ä»£ç¢¼</th><th>åç¨±</th><th>æ”¶ç›¤åƒ¹</th><th>æ¼²è·Œå¹… (%)</th>
  </tr></thead><tbody>`;

  items.forEach(item => {
    const delta = calcDelta(item, yesterdayMap);
    const close = Number(item.close);
    const pct = Number(item.changePct);

    const cls = pct >= 0 ? "up" : "down";
    html += `
      <tr>
        <td>${item.rank}</td>
        <td class="${delta.cls}">${delta.label}</td>
        <td>${item.code}</td>
        <td>${item.name}</td>
        <td>${Number.isFinite(close) ? close.toFixed(2) : "0.00"}</td>
        <td class="${cls}">${Number.isFinite(pct) ? pct.toFixed(2) : "0.00"}</td>
      </tr>`;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}

/* ====== Main ====== */
async function run() {
  console.log("KC AiOS: run() start");

  const todayData = await loadTodayData();
  const yData = await loadYesterdayData();

  // å»ºç«‹æ˜¨å¤© rank mapï¼ˆcode â†’ rankï¼‰
  let yMap = {};
  if (yData && Array.isArray(yData.items)) {
    yData.items.forEach(item => {
      yMap[item.code] = item.rank;
    });
  }

  const container = document.getElementById("content");
  if (!todayData || !todayData.items) {
    if (container) container.innerText = "ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼šè«‹ç¢ºèª data/latest.json æ˜¯å¦å­˜åœ¨ä¸”å¯è®€å–ã€‚";
    console.error("todayData invalid:", todayData);
    return;
  }

  renderMeta(todayData, yData);
  renderTable(todayData.items, yMap);
}


window.run = run;

/* ====== Auto Boot (iOS/Safari Safe) ====== */
const BUILD_ID = "2026-01-15-v3";
console.log("KC Dashboard build:", BUILD_ID);

// âœ… é€™å€‹å¯«æ³•æ¯” DOMContentLoaded æ›´ç©©ï¼šäº‹ä»¶éŒ¯éä¹Ÿæœƒç«‹åˆ»åŸ·è¡Œ
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", () => window.run(), { once: true });
} else {
  window.run();
}
</script>
</body>
</html>
